{"version":3,"sources":["webpack:///./src/ui/src/components/CalibrationModal/CalibrationModal.scss?9537","webpack:///./src/ui/src/helpers/evalFraction.js","webpack:///./src/ui/src/components/CalibrationModal/CalibrationModal.js","webpack:///./src/ui/src/components/CalibrationModal/index.js"],"names":["module","exports","fraction","_fraction$split2","_slicedToArray","split","numerator","denominator","Number","parseMeasurementContentsByAnnotation","annotation","factor","Measure","axis","Scale","getLineLength","numberRegex","fractionRegex","pureFractionRegex","CalibrationModal","core","useCore","_useSelector2","useSelector","state","selectors","isElementOpen","DataElements","CALIBRATION_MODAL","isElementDisabled","getMeasurementUnits","shallowEqual","isOpen","isDisabled","units","dispatch","useDispatch","_useState2","useState","setAnnotation","_useState4","value","setValue","_useState6","newDistance","setNewDistance","_useState8","unitTo","setUnitTo","_useState0","showError","setShowError","t","useTranslation","inputRef","useRef","useEffect","_inputRef$current","current","focus","handleAnnotationsSelected","getSelectedAnnotations","onAnnotationSelected","annotations","action","addEventListener","removeEventListener","onAnnotationChanged","length","toFixed","mapAnnotationToKey","annot","parseFloat","handleLossOfPrecision","scale","getNewScale","currentDistance","ratio","currentScale","closeModal","actions","closeElements","React","createElement","Swipeable","onSwipedUp","onSwipedDown","preventDefaultTouchmoveEvent","className","classNames","Modal","open","closed","onMouseDown","e","stopPropagation","ref","type","onChange","target","onBlur","inputValue","trim","test","_inputValue$split2","whole","isFinite","evalFraction","number","to","map","unit","key","Button","dataElement","label","onClick","newScale","accurateNewScale","setAnnotationStyles","setToolStyles","disabled"],"mappings":"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","file":"chunks/chunk.59.js","sourcesContent":["// extracted by mini-css-extract-plugin\nmodule.exports = {\"LEFT_HEADER_WIDTH\":\"41px\",\"RIGHT_HEADER_WIDTH\":\"41px\"};","export default (fraction) => {\n  const [numerator, denominator] = fraction.split('/');\n  return Number(numerator) / Number(denominator);\n};\n","import React, { useState, useEffect, useRef } from 'react';\nimport classNames from 'classnames';\nimport { useSelector, useDispatch, shallowEqual } from 'react-redux';\nimport { useTranslation } from 'react-i18next';\nimport Button from 'components/Button';\nimport useCore from 'hooks/useCore';\nimport { mapAnnotationToKey } from 'constants/map';\nimport setToolStyles from 'helpers/setToolStyles';\nimport evalFraction from 'helpers/evalFraction';\nimport actions from 'actions';\nimport selectors from 'selectors';\nimport { Swipeable } from 'react-swipeable';\nimport DataElements from 'constants/dataElement';\n\nimport './CalibrationModal.scss';\n\nconst parseMeasurementContentsByAnnotation = (annotation) => {\n  const factor = annotation.Measure.axis[0].factor;\n  const unit = annotation.Scale[1][1];\n\n  switch (unit) {\n    case 'ft-in':\n      return (annotation.getLineLength() * factor / 12);\n    case 'in':\n    default:\n      return (annotation.getLineLength() * factor);\n  }\n};\n\nconst numberRegex = /^\\d*(\\.\\d*)?$/;\nconst fractionRegex = /^\\d*(\\s\\d\\/\\d*)$/;\nconst pureFractionRegex = /^(\\d\\/\\d*)*$/;\n\nconst CalibrationModal = () => {\n  const { core } = useCore();\n  const [isOpen, isDisabled, units] = useSelector(\n    (state) => [\n      selectors.isElementOpen(state, DataElements.CALIBRATION_MODAL),\n      selectors.isElementDisabled(state, DataElements.CALIBRATION_MODAL),\n      selectors.getMeasurementUnits(state),\n    ],\n    shallowEqual\n  );\n  const dispatch = useDispatch();\n  const [annotation, setAnnotation] = useState(null);\n  const [value, setValue] = useState('');\n  const [newDistance, setNewDistance] = useState(0);\n  const [unitTo, setUnitTo] = useState('');\n  const [showError, setShowError] = useState(false);\n  const [t] = useTranslation();\n  const inputRef = useRef(null);\n\n  useEffect(() => {\n    isOpen && inputRef?.current?.focus();\n    handleAnnotationsSelected(core.getSelectedAnnotations());\n  }, [isOpen]);\n\n  useEffect(() => {\n    const onAnnotationSelected = (annotations, action) => {\n      if (action === 'selected') {\n        handleAnnotationsSelected(annotations);\n      } else if (action === 'deselected') {\n        setAnnotation(null);\n        setValue('');\n        setUnitTo('');\n        setNewDistance(0);\n      }\n    };\n\n    core.addEventListener('annotationSelected', onAnnotationSelected);\n\n    return () => core.removeEventListener('annotationSelected', onAnnotationSelected);\n  }, []);\n\n  useEffect(() => {\n    const onAnnotationChanged = (annotations, action) => {\n      if (\n        action === 'modify' &&\n        annotations.length === 1 &&\n        annotations[0] === annotation\n      ) {\n        setValue(parseMeasurementContentsByAnnotation(annotation).toFixed(2));\n        setUnitTo(annotation.Scale[1][1]);\n      }\n    };\n\n    core.addEventListener('annotationChanged', onAnnotationChanged);\n    return () => core.removeEventListener('annotationChanged', onAnnotationChanged);\n  }, [annotation]);\n\n  const handleAnnotationsSelected = (annotations) => {\n    if (\n      annotations?.length === 1 &&\n      mapAnnotationToKey(annotations[0]) === 'distanceMeasurement'\n    ) {\n      const annot = annotations[0];\n      setAnnotation(annot);\n      const value = parseMeasurementContentsByAnnotation(annot).toFixed(2);\n      setValue(value);\n      setUnitTo(annot.Scale[1][1]);\n      // initial new distance should be the same as the value\n      // in case the user doesn't change the input value\n      setNewDistance(parseFloat(value));\n    }\n  };\n\n  const handleInputChange = (e) => {\n    setShowError(false);\n    setValue(e.target.value);\n  };\n  const validateInput = (e) => {\n    const inputValue = e.target.value.trim();\n    if (inputValue === '') {\n      setShowError(true);\n    }\n    if (numberRegex.test(inputValue)) {\n      const newDistance = parseFloat(inputValue);\n      if (newDistance !== 0) {\n        setNewDistance(parseFloat(inputValue));\n        setValue(inputValue);\n      } else {\n        setShowError(true);\n      }\n    } else if (fractionRegex.test(inputValue)) {\n      const [whole, fraction] = inputValue.split(' ');\n      if (Number.isFinite(evalFraction(fraction))) {\n        const number = Number(whole) + evalFraction(fraction);\n        setNewDistance(parseFloat(number));\n        setValue(number);\n      } else {\n        setShowError(true);\n      }\n    } else if (pureFractionRegex.test(inputValue)) {\n      if (Number.isFinite(evalFraction(inputValue))) {\n        const number = evalFraction(inputValue);\n        setNewDistance(parseFloat(number));\n        setValue(number);\n      } else {\n        setShowError(true);\n      }\n    } else {\n      setShowError(true);\n    }\n  };\n\n  const handleSelectChange = (e) => {\n    setUnitTo(e.target.value);\n  };\n  const handleApply = () => {\n    const newScale = getNewScale();\n    const accurateNewScale = handleLossOfPrecision(newScale);\n\n    core.setAnnotationStyles(annotation, {\n      Scale: accurateNewScale,\n    });\n\n    // this will also set the Scale for the other two measurement tools\n    setToolStyles(\n      'AnnotationCreateDistanceMeasurement',\n      'Scale',\n      accurateNewScale\n    );\n\n    dispatch(actions.closeElements([DataElements.CALIBRATION_MODAL]));\n  };\n\n  const handleLossOfPrecision = (scale) => {\n    // when the new distance that's entered in the modal is much bigger than the current distance, loss of precision can happen\n    // because internally WebViewer will do several multiplications and divisions to get the value to store in a measure dictionary\n    // in this case, setting 'Scale' again should fix this issue because this time the new distance and the current distance is very close, and we should get the accurate scale\n    annotation.Scale = scale;\n\n    return getNewScale();\n  };\n\n  const getNewScale = () => {\n    const currentDistance = parseMeasurementContentsByAnnotation(annotation);\n    const ratio = newDistance / currentDistance;\n\n    const currentScale = annotation.Scale;\n    const newScale = [\n      [currentScale[0][0], currentScale[0][1]],\n      [currentScale[1][0] * ratio, unitTo],\n    ];\n\n    return newScale;\n  };\n\n  const closeModal = () => {\n    dispatch(actions.closeElements([DataElements.CALIBRATION_MODAL]));\n  };\n  return isDisabled || !annotation ? null : (\n    <Swipeable\n      onSwipedUp={closeModal}\n      onSwipedDown={closeModal}\n      preventDefaultTouchmoveEvent\n    >\n      <div\n        className={classNames({\n          Modal: true,\n          CalibrationModal: true,\n          open: isOpen,\n          closed: !isOpen,\n        })}\n        onMouseDown={closeModal}\n      > <div className=\"container\" onMouseDown={(e) => e.stopPropagation()}>\n          <div className=\"swipe-indicator\" />\n          <div className=\"calibration__header\">\n            {t('component.calibration')}\n          </div>\n          <div className=\"calibration__body\">\n            <div>{t('message.enterMeasurement')}</div>\n            <div className=\"calibration__input\">\n              <input\n                className={showError ? 'error' : ''}\n                ref={inputRef}\n                type=\"text\"\n                value={value}\n                onChange={handleInputChange}\n                onBlur={validateInput}\n              />\n              <select\n                className=\"unitToInput\"\n                value={unitTo}\n                onChange={handleSelectChange}\n              >\n                {units.to.map((unit) => (\n                  <option key={unit} value={unit}>\n                    {unit}\n                  </option>\n                ))}\n              </select>\n            </div>\n            {showError ? <div className=\"errorMeasurement\">{t('message.errorEnterMeasurement')}</div> : null}\n          </div>\n          <div className=\"calibration__footer\">\n            <Button\n              dataElement=\"passwordSubmitButton\"\n              label={t('action.apply')}\n              onClick={handleApply}\n              disabled={showError}\n            />\n          </div>\n        </div>\n      </div>\n    </Swipeable>\n  );\n};\n\nexport default CalibrationModal;\n","import CalibrationModal from './CalibrationModal';\n\nexport default CalibrationModal;"],"sourceRoot":""}